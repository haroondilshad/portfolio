<!-- Extended head.html to fix mixed content issues and optimize performance -->
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

{{- if hugo.IsProduction | or (eq site.Params.env "production") | and (ne .Params.robotsNoIndex true) }}
<meta name="robots" content="index, follow">
{{- else }}
<meta name="robots" content="noindex, nofollow">
{{- end }}

{{- partial "templates/twitter_cards.html" . }}
{{- partial "templates/opengraph.html" . }}
{{- partial "templates/schema_json.html" . }}

{{- $title := ( .Title ) }}
{{- $siteTitle := ( site.Title ) }}
{{- if .IsHome }}
{{ $title = $siteTitle }}
{{- else }}
{{ $title = printf "%s | %s" .Title $siteTitle }}
{{- end }}

<title>{{ $title }}</title>

<meta name="title" content="{{ $title }}">
{{- if .Description }}
<meta name="description" content="{{ .Description }}">
{{- else if .Summary }}
<meta name="description" content="{{ .Summary }}">
{{- else if .Params.summary }}
<meta name="description" content="{{ .Params.summary }}">
{{- else if site.Params.description }}
<meta name="description" content="{{ site.Params.description }}">
{{- end }}

<meta name="keywords" content="{{ (delimit .Keywords " ") }}">
<meta name="author" content="{{ (partial "author.html" . ) }}">
<link rel="canonical" href="{{ .Permalink }}">

{{- if site.Params.analytics.google.SiteVerificationTag }}
<meta name="google-site-verification" content="{{ site.Params.analytics.google.SiteVerificationTag }}">
{{- end }}
{{- if site.Params.analytics.yandex.SiteVerificationTag }}
<meta name="yandex-verification" content="{{ site.Params.analytics.yandex.SiteVerificationTag }}">
{{- end }}
{{- if site.Params.analytics.bing.SiteVerificationTag }}
<meta name="msvalidate.01" content="{{ site.Params.analytics.bing.SiteVerificationTag }}">
{{- end }}
{{- if site.Params.analytics.naver.SiteVerificationTag }}
<meta name="naver-site-verification" content="{{ site.Params.analytics.naver.SiteVerificationTag }}">
{{- end }}

{{- /* Favicon - Fixed HTTPS URLs */ -}}
<link rel="icon" href="{{ site.BaseURL }}favicon/favicon.ico">
<link rel="icon" type="image/png" sizes="16x16" href="{{ site.BaseURL }}favicon/favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="{{ site.BaseURL }}favicon/favicon-32x32.png">
<link rel="apple-touch-icon" href="{{ site.BaseURL }}favicon/apple-touch-icon.png">
<link rel="manifest" href="{{ site.BaseURL }}favicon/site.webmanifest">

{{- /* Preload critical resources for better performance */ -}}
{{- if eq .Kind "home" }}
<link rel="preload" href="{{ site.BaseURL }}profile.jpeg" as="image" fetchpriority="high">
{{- end }}

{{- /* Styles */ -}}
{{- $theme_vars := (resources.Get "css/core/variables.css") }}
{{- $reset := (resources.Get "css/core/reset.css") }}
{{- $media := (resources.Get "css/core/zmedia.css") }}
{{- $license_css := (resources.Get "css/core/license.css") }}
{{- $common := (resources.Match "css/common/*.css") | resources.Concat "assets/css/common.css" }}

{{- /* include `an-old-hope` if hljs is on */ -}}
{{- $isHLJSdisabled := (site.Params.assets.disableHLJS | default false) }}
{{- $hljs := (cond ($isHLJSdisabled) (" " | resources.FromString "assets/css/hljs-blank.css") (resources.Get "css/hljs/an-old-hope.min.css")) }}

{{- /* order is important */ -}}
{{- $core := (slice $theme_vars $reset $common $hljs $media) | resources.Concat "assets/css/core.css" | resources.Minify }}
{{- $extended := (resources.Match "css/extended/*.css") | resources.Concat "assets/css/extended.css" | resources.Minify }}

{{- /* bundle all required css */ -}}
{{- /* Add extended css after theme style */ -}}
{{- if not (eq $extended.Content "") }}
{{- $core_extended := (slice $core $extended) | resources.Concat "assets/css/stylesheet.css" | resources.Minify }}
<link crossorigin="anonymous" href="{{ $core_extended.RelPermalink }}" integrity="{{ $core_extended.Data.Integrity }}" rel="preload stylesheet" as="style">
{{- else }}
<link crossorigin="anonymous" href="{{ $core.RelPermalink }}" integrity="{{ $core.Data.Integrity }}" rel="preload stylesheet" as="style">
{{- end }}

{{- with site.Params.profileMode }}
{{- if and .enabled .imageUrl $.IsHome }}
{{- with site.GetPage "/" }}
{{- $image := resources.Get .Params.profileMode.imageUrl }}
{{- if $image }}
<link rel="preload" as="image" href="{{ $image.RelPermalink }}" fetchpriority="high" {{- if .Params.profileMode.imageTitle }} crossorigin{{- end }}>
{{- end }}
{{- end }}
{{- end }}
{{- end }}

{{- with .OutputFormats.Get "rss" -}}
{{ printf `<link rel="%s" type="%s" href="%s" title="%s">` .Rel .MediaType.Type .Permalink site.Title | safeHTML }}
{{- end }}

{{- template "_internal/google_analytics.html" . }}

{{- if hugo.IsProduction | or (eq site.Params.env "production") }}
{{- template "_internal/google_analytics.html" . }}
{{- template "partials/templates/opengraph.html" . }}
{{- template "partials/templates/twitter_cards.html" . }}
{{- template "partials/templates/schema_json.html" . }}
{{- end }}
